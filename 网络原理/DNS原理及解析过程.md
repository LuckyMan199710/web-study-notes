## DNS原理及解析过程

`DNS`是互联网过程中不可缺少的重要组成部分，访问互联网的第一步就是进行`DNS`解析，下面来讲讲`DNS`以及它是如何进行解析的。

### 什么是DNS？

`DNS`又称为域名系统，是将域名和电脑主机的`ip`地址相互映射的一个分布式数据库，并且负责将用户提供的域名解析为对应的`ip`地址。

通俗点来说，就是把一个叫做“域名"的东西和主机的`ip`地址作为一个映射关系保存起来，然后可以通过这个”域名“可以获取到对应主机的`ip`地址。

### 什么是域名？
域名简单来说，可以理解为电脑主机`ip`地址的一个外号。域名的出现是为了解决主机`ip`地址的一系列问题，比如：

1. 因为`ip`地址是由一串数字表示，所以记起来不方便
2. `ip`地址不能够体验企业的名称和性质等特点

这里稍微举个例子，比如`202.108.22.5`是百度的首页，而`baidu.com`则是域名，对于记住这个网址，很明显后者比前者要好记得多。
并且，通过`baidu.com`这个域名，可以清楚地了解到这个网址是百度旗下的，而单纯凭一串密密麻麻的`ip`则表示不出来什么。

**域名是具有唯一性的**，也就是说，互联网上不可能存在两个一模一样的域名。

### 域名的结构
域名的结构呈树状分布，从上到下依次为**根域名**、**顶级域名(一级域名)**、**二级域名**、**三级域名**，如下图：

![](./images/域名结构.jpg)

对域名的书写，是从左到右域名的等级越来越高，以`.`作为等级的划分，比如`www.baidu.com`。

接下来对这几个等级的域名进行介绍：

#### 根域名
根域名是整个域名结构中等级最高的，它管理着所有的顶级域名，可以说，根域名掌握着全世界所有域名的命脉，假设根域名管理的某个顶级域名的记录突然消失，那么该顶级域名下的所有子域名将无法被访问。目前根域名由一个叫做`ICANN`的机构所管理。

一般在书写域名的时候，都会忽略根域名的书写，比如`www.baidu.com`，实际上完整写法是`www.baidu.com.`最后的这个`.`就是代表了根域名。

#### 顶级域名

顶级域名又被称为一级域名，处于域名等级的第二层次，由根域名进行管理，一般分为三种类型：
1. 国家和地区顶级域名，比如中国是`.cn`、日本是`.jp`等，一般这类网站面向国内。
2. 国际顶级域名，例如`.com`表示的是企业，表示网络提供商的`.net`，一些非营利性组织则是`.org`等，这一类域名一般面向国际。
3. 新顶级域名，如通用的`.xyz`、代表“高端”的`.top`、代表“红色”的`.red`等。

#### 二级域名

二级域名则是处于域名等级中的第三层次，由顶级域名进行管理，一般二级域名根据顶级域名的类型还有所区分：

1. 如果顶级域名是国际顶级名，那么二级域名一般是企业自行注册的，例如`baidu.com`、`yahoo.com`这种。
2. 如果顶级域名是国家和地区顶级域名，那么二级域名一般是用来表示企业的类型，比如`.com`、`.org`、`.gov`等，比如中国政府网`www.gov.cn`。

#### 三级域名

三级域名则是在二级域名下的子域名，一般三级域名由注册人自行定义，比如`baike.baidu.com`。一般长度不能超过20个字符，所以注册人的三级域名应当具有简洁性和清晰性。

### 域名服务器

域名服务器是`DNS`系统的重要组成部分，负责域名的解析过程，每个域名服务器都有属于自己管理的一个域，服务器之间互不影响。

1. 主域名服务器：主要负责特定区域的域名信息的解析以及维护，它是特定区域内所有主机数据的来源，也就是说，该区域的所有主机数据都是来自主域名服务器，并且只有这一条来源。
2. 辅助域名服务器：协助主域名服务器提供查询服务，可以减少主域名服务器的负载。并且，在主域名服务器宕机或者无法解析等情况时，保证域名解析能够照常进行。辅助域名服务器中的数据是从主域名服务器复制过来的。
3. 缓存域名服务器：这是一种特殊的服务器，它本身不管理任何域。而当它接收到`DNS`请求时，会将请求转发给其他`DNS`服务器处理，当接收到处理的结果时，则会将数据缓存起来。下次接收到相同的`DNS`请求时，直接将缓存数据作为结果返回。
4. 转发域名服务器：这种服务器只负责将接收到的`DNS`请求转发给上级的`DNS`服务器进行处理，不具备其他功能。

### 域名解析过程
在讲解析过程之前，需要了解以下几个知识点：

**权威服务器**：一般来说，如果管理某个域`DNS`服务器的内部配置文件写明了域名和主机的对应关系，那么该服务器称为这个域的权威服务器，它的解析过程是具有权威性的，如果不通过权威`DNS`服务器解析，而是通过缓存得到的结果则不具有权威性。

**本地DNS服务器**：为了加快`DNS`解析速度，互联网接入服务运营商或者一些大型网络机构，像公司、大学等都有一台或多台可以自行管理的域名服务器，这类域名服务器称为本地域名服务器，也称为默认域名服务器，一般来说，这台服务器离我们是比较近的。

**hosts文件**：这个文件没有任何扩展名，存储在本地计算机中，作用就是将一些常用的网址域名与其对应的`IP`地址建立一个关联“数据库”。

以百度网为例，当我们在网址输入`www.baidu.com`时，通过`DNS`解析最终跳转成功的过程大概如下：

1. 浏览器检查自身的缓存，是否存在解析域名对应的`ip`地址，如果存在，解析结束，否则进行下一步。

2. 浏览器检查本地的`hosts`文件是否存在解析域名对应的`ip`地址，如果存在，解析结束，否则进行下一步。

3. 向**本地域名服务器**发送请求，当本地域名服务器接收到请求之后，会进行以下操作：

	( 1 ) 当本地域名服务器接收到`DNS`请求时，首先检测该域名包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。
	( 2 ) 如果查询的域名不是由本地域名时，就检测自身是否缓存了其他域名服务器返回的处理结果，如果存在则返回，此解析不具有权威性。如果不存在，就直接向**根域名服务器**发送请求。
	
4. 根域名服务器接收到请求之后，会判断是该域由哪台顶级域名服务器进行管理，然后将该**顶级域名服务器**的地址返回给本地域名服务器。在例子中，根域名服务器会将管理`.com`的顶级域名服务器的地址返回。

5. 本地域名服务器根据接收到的信息，再向对应的顶级域名服务器发送请求，如果顶级域名服务器不能解析，那么就会接着查询其管理的负责该域名解析的下级域名服务器，并将这个服务器的地址返回给本地域名服务器。

   在例子中，当`.com`顶级域名服务器发现自身无法解析之后，就会查询`.com`下负责解析`baidu.com`的域名服务器，并将对应的地址返回给本地`DNS`服务器。
   
6. 重复第5点的操作，不断往下层寻找，直到找到最终的目标主机，获取解析结果。
7. 本地域名服务器获取到最终的解析结果并返回给用户，同时它也将结果缓存到自身，并且设置缓存时间。

不过还有一种情况，如果域名服务器采用的是**转发模式**的话，那么当本地域名服务器自身解析不了的时候，就会把查询请求转发出去，让其他域名服务器进行解析。

### 域名劫持

域名劫持是指攻击者利用伪造域名服务器、攻击域名服务器等方式，使得域名解析出错误的`ip`地址，从而让用户无法访问目标网站或者蓄意或恶意要求用户访问指定`ip`地址。

比如用户在登录某银行网站A，当用户输入网址时，遭受域名劫持，结果跳转到了网站B，而不法分子将网站B制作的和银行网站A一模一样。但是用户并没有发现，依旧输入了账号以及密码，那么个人私密信息就被不法分子所窃取。

实际上域名劫持很难预防，以下列出几点可以预防的方案：
1. 如果知道目标网站的`ip`地址，可以直接使用`ip`访问（前提是人家没有禁止`ip`解析）
2. 手动修改`DNS`
3. 修改路由器密码
4. 如果是企业的话，最好准备多个域名，如果一个域名被劫持了还可以通过其它域名进行访问。

